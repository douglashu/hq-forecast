<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hq.flood.dao.custom.OperRoleDao">
    <resultMap id="BaseResultMap" type="com.hq.flood.service.entity.response.BatchOperRoleRsp">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Dec 15 10:43:20 CST 2016.
        -->
        <id column="ROLE_ID" jdbcType="VARCHAR" property="roleId"/>
        <result column="SYSTEM_ID" jdbcType="VARCHAR" property="systemId"/>
        <result column="ROLE_NAME" jdbcType="VARCHAR" property="roleName"/>
        <result column="ROLE_DESC" jdbcType="VARCHAR" property="roleDesc"/>
        <result column="ROLE_STATUS" jdbcType="CHAR" property="roleStatus"/>
        <result column="TEMPLATE_ID" jdbcType="INTEGER" property="templateId"/>
        <result column="OPER_ID" jdbcType="INTEGER" property="operId"/>
    </resultMap>

    <delete id="deleteOperRoleWithRoleTemplate">
         delete from t_flood_oper_role
         where 1=1
         and oper_id = #{operId}
         and role_id in(
         select role_id from t_flood_role r
         inner join t_flood_role_template t on r.template_id = t.id
         where 1=1
         and r.urm_id=#{urmId})
    </delete>

    <select id="batchRoles" resultMap="BaseResultMap">
        select r.role_id,r.role_name,r.template_id,r.role_status,r.system_id,r.role_desc,ro.oper_id
        from t_flood_role r inner join t_flood_oper_role ro on ro.role_id = r.role_id
        where 1=1
        and r.role_status = 0
        and r.system_id= #{systemId}
        and ro.oper_id in
        <foreach item="item" index="index" collection="operIds" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectSubOpers" resultType="TFloodOperRole">
        select o.id,o.oper_id operId,o.role_id roleId
        from t_flood_oper_role o
        Inner join t_flood_role fr on o.role_id = fr.role_id
        Inner join t_flood_role_template frt on fr.TEMPLATE_ID = frt.id
        where frt.sequence > (
            select sequence from t_flood_role_template t
            INNER join t_flood_role frr on t.id = frr.template_id
            where 1=1
            and t.state = 0
            and frr.role_id = #{roleId}
            <if test="pcoreId != null">
            and frr.URM_ID=#{pcoreId}
            </if>
            <if test="pcoreId == null">
                and frr.URM_ID = #{coreId}
            </if>
        ) and fr.URM_ID=#{coreId}
    </select>

</mapper>